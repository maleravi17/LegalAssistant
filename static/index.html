<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lexi</title>
    <style>
        /* Existing styles remain the same */
    </style>
</head>
<body class="dark">
    <div id="container">
        <div id="chat-container" class="dark">
            <div id="controls">
                <button id="new-chat" class="control-btn dark" data-tooltip="New Chat">âž•</button>
                <button id="history-toggle" class="control-btn dark" data-tooltip="History">ðŸ“œ</button>
                <div id="theme-switch">
                    <label>
                        <input type="checkbox" id="theme-toggle">
                        <span class="switch"></span>
                        <span>Light</span>
                        <span>Dark</span>
                    </label>
                </div>
            </div>
            <div id="chat-header" class="dark">Lexi</div>
            <div id="chat-display" class="dark">
                <div class="message bot dark">Hi! Iâ€™m your Lexi. Ask me about Indian law, IPC sections, or anything legal!</div>
            </div>
            <form id="chat-form">
                <textarea id="prompt" class="dark" placeholder="Ask me anything legal..." required></textarea>
                <label class="upload-btn dark" for="file-upload" data-tooltip="Attach">ðŸ“Ž</label>
                <input type="file" id="file-upload" style="display: none;" accept="image/*,application/pdf">
                <button type="submit" class="send-btn dark">â†‘</button>
            </form>
        </div>
        <div id="sidebar" class="dark">
            <h2 class="dark">Chat History</h2>
            <button id="close-sidebar" class="dark">Close</button>
            <ul id="history-list"></ul>
        </div>
    </div>

    <script>
        const chatDisplay = document.getElementById('chat-display');
        const chatForm = document.getElementById('chat-form');
        const promptInput = document.getElementById('prompt');
        const newChatBtn = document.getElementById('new-chat');
        const historyToggleBtn = document.getElementById('history-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const fileUpload = document.getElementById('file-upload');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const historyList = document.getElementById('history-list');
        const chatContainer = document.getElementById('chat-container');
        const chatHeader = document.getElementById('chat-header');

        let sessionId = localStorage.getItem('sessionId') || 'pla_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('sessionId', sessionId);
        let historySessions = JSON.parse(localStorage.getItem('historySessions')) || [];
        let lastPrompt = null; // Store the last question for regeneration
        let isDarkTheme = localStorage.getItem('theme') !== 'light';

        applyTheme(isDarkTheme);
        loadSession(sessionId);

        // Dynamic textarea height while typing
        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = `${promptInput.scrollHeight}px`;
        });

        // Theme toggle switch
        themeToggle.addEventListener('change', () => {
            isDarkTheme = !themeToggle.checked;
            applyTheme(isDarkTheme);
            localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
        });

        // File upload handling
        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const fileContent = event.target.result;
                    addMessage('user', `Uploaded ${file.name}: [Content preview not shown, processed by bot]`);
                    // Simulate bot response (replace with actual processing logic)
                    addMessage('bot', `Thank you for uploading ${file.name}. Iâ€™m analyzing it. Would you like more information?`, true);
                };
                reader.readAsDataURL(file); // For images, use readAsText for PDFs
                fileUpload.value = ''; // Reset file input
            }
        });

        newChatBtn.addEventListener('click', () => {
            sessionId = 'pla_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('sessionId', sessionId);
            chatDisplay.innerHTML = '<div class="message bot ' + (isDarkTheme ? 'dark' : 'light') + '">Hi! Iâ€™m your Lexi. Ask me about Indian law, IPC sections, or anything legal!</div>';
            updateHistory();
            sidebar.classList.remove('open');
            sidebar.style.display = 'none';
        });

        historyToggleBtn.addEventListener('click', () => {
            toggleSidebar();
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebar.style.display = 'none';
        });

        sidebar.addEventListener('click', (e) => {
            if (e.target === sidebar) {
                sidebar.classList.remove('open');
                sidebar.style.display = 'none';
            }
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = promptInput.value.trim();
            if (!prompt && !fileUpload.files.length) return;

            if (prompt) {
                lastPrompt = prompt; // Store the last question
                addMessage('user', prompt);
                promptInput.value = '';
                promptInput.style.height = 'auto';
                const typing = addMessage('bot', 'Decoding legal mysteries...');

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            prompt: prompt
                        })
                    });
                    const data = await response.json();
                    chatDisplay.removeChild(typing);
                    if (response.ok) {
                        const botResponse = `Thank you for your question. ${data.response} Would you like more information?`;
                        const message = addMessage('bot', botResponse, true);
                        const regenerateBtn = document.createElement('button');
                        regenerateBtn.textContent = 'ðŸ”„';
                        regenerateBtn.classList.add('action-btn', isDarkTheme ? 'dark' : 'light');
                        regenerateBtn.setAttribute('data-tooltip', 'Regenerate');
                        regenerateBtn.onclick = () => regenerateResponse();
                        message.querySelector('.actions').appendChild(regenerateBtn);
                        updateHistory();
                    } else {
                        addMessage('bot', 'Error: ' + data.detail);
                    }
                } catch (error) {
                    chatDisplay.removeChild(typing);
                    addMessage('bot', 'Sorry, I couldnâ€™t connect to the server. Please try again.');
                }
            }
        });

        async function regenerateResponse() {
            if (!lastPrompt) return;
            const typing = addMessage('bot', 'Regenerating response...');
            try {
                const response = await fetch('/regenerate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        prompt: lastPrompt // Note: This is a placeholder; adjust if needed
                    })
                });
                const data = await response.json();
                chatDisplay.removeChild(typing);
                if (response.ok) {
                    const botResponse = `Thank you for your question. ${data.response} Would you like more information?`;
                    const lastUserMessage = chatDisplay.querySelector('.user:last-child');
                    const nextBotMessage = lastUserMessage ? lastUserMessage.nextElementSibling : null;
                    if (nextBotMessage && nextBotMessage.classList.contains('bot')) {
                        chatDisplay.removeChild(nextBotMessage);
                    }
                    addMessage('bot', botResponse, true);
                } else {
                    addMessage('bot', 'Error: ' + data.detail);
                }
            } catch (error) {
                chatDisplay.removeChild(typing);
                addMessage('bot', 'Sorry, I couldnâ€™t regenerate the response. Please try again.');
            }
        }

        async function loadSession(id) {
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: id,
                        prompt: "Load this session"
                    })
                });
                const data = await response.json();
                chatDisplay.innerHTML = '';
                const sessionData = JSON.parse(localStorage.getItem(id)) || [];
                sessionData.forEach(msg => addMessage(msg.role, msg.text, msg.role === 'bot'));
                if (data.response && !sessionData.length) {
                    addMessage('bot', data.response, true);
                }
            } catch (error) {
                addMessage('bot', 'Failed to load session history.');
            }
        }

        function updateHistory() {
            historySessions = JSON.parse(localStorage.getItem('historySessions')) || [];
            if (!historySessions.includes(sessionId)) {
                historySessions.push(sessionId);
                localStorage.setItem('historySessions', JSON.stringify(historySessions));
            }
            historyList.innerHTML = '';
            historySessions.forEach(id => {
                const li = document.createElement('li');
                li.classList.add(isDarkTheme ? 'dark' : 'light');
                li.textContent = `Session ${id.slice(4, 10)}`;
                li.addEventListener('click', () => {
                    sessionId = id;
                    localStorage.setItem('sessionId', id);
                    loadSession(id);
                    sidebar.classList.remove('open');
                    sidebar.style.display = 'none';
                });
                historyList.appendChild(li);
            });
        }

        function toggleSidebar() {
            if (sidebar.style.display === 'none') {
                sidebar.style.display = 'block';
                sidebar.classList.add('open');
            } else {
                sidebar.classList.remove('open');
                sidebar.style.display = 'none';
            }
        }

        function applyTheme(dark) {
            isDarkTheme = dark;
            document.body.classList.toggle('dark', isDarkTheme);
            document.body.classList.toggle('light', !isDarkTheme);
            chatContainer.classList.toggle('dark', isDarkTheme);
            chatContainer.classList.toggle('light', !isDarkTheme);
            chatHeader.classList.toggle('dark', isDarkTheme);
            chatHeader.classList.toggle('light', !isDarkTheme);
            chatDisplay.classList.toggle('dark', isDarkTheme);
            chatDisplay.classList.toggle('light', !isDarkTheme);
            promptInput.classList.toggle('dark', isDarkTheme);
            promptInput.classList.toggle('light', !isDarkTheme);
            sidebar.classList.toggle('dark', isDarkTheme);
            sidebar.classList.toggle('light', !isDarkTheme);
            sidebar.querySelector('h2').classList.toggle('dark', isDarkTheme);
            sidebar.querySelector('h2').classList.toggle('light', !isDarkTheme);
            newChatBtn.classList.toggle('dark', isDarkTheme);
            newChatBtn.classList.toggle('light', !isDarkTheme);
            historyToggleBtn.classList.toggle('dark', isDarkTheme);
            historyToggleBtn.classList.toggle('light', !isDarkTheme);
            closeSidebarBtn.classList.toggle('dark', isDarkTheme);
            closeSidebarBtn.classList.toggle('light', !isDarkTheme);
            document.querySelectorAll('.message').forEach(msg => {
                msg.classList.toggle('dark', isDarkTheme);
                msg.classList.toggle('light', !isDarkTheme);
            });
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.toggle('dark', isDarkTheme);
                btn.classList.toggle('light', !isDarkTheme);
            });
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.toggle('dark', isDarkTheme);
                btn.classList.toggle('light', !isDarkTheme);
            });
            document.querySelectorAll('#history-list li').forEach(li => {
                li.classList.toggle('dark', isDarkTheme);
                li.classList.toggle('light', !isDarkTheme);
            });
            themeToggle.checked = !isDarkTheme;
        }
    </script>
</body>
</html>
